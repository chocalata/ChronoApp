---
import Layout from "../layouts/Layout.astro";

import Chronometer from "../components/functions/Chronometer.astro";
import Countdown from "../components/functions/Countdown.astro";
import IntervalTimer from "../components/functions/IntervalTimer.astro";

console.log("Cargando index");
---

<Layout title="Chrono app">
	<main class="h-full">
		<div id="countdown-container">
			<Countdown />
		</div>
		<div id="chronometer-container" style="display: none;">
			<Chronometer />
		</div>
		<div id="interval-timer-container" style="display: none;">
			<IntervalTimer />
		</div>
	</main>
</Layout>

<script>
	interface PageSelectEvent extends CustomEvent {
		detail: {
			page: string;
		};
	}

	interface UserDataEvent extends CustomEvent {
		detail: {
			data: any;
			function: string;
		};
	}

	// Object mapping pages to their container IDs
	const pageContainers = {
		countdown: "countdown-container",
		chronometer: "chronometer-container",
		"interval-timer": "interval-timer-container",
	};

	// Function to show selected page and hide others
	function showPage(selectedPage: string) {
		Object.entries(pageContainers).forEach(([page, containerId]) => {
			const container = document.getElementById(containerId);
			if (container) {
				container.style.display =
					page === selectedPage ? "block" : "none";
			}
		});
	}

	// Listen for page selection event
	document.addEventListener("onSelect", ((e: PageSelectEvent) => {
		showPage(e.detail.page);
	}) as EventListener);

	function setJsonCookie(name, jsonData) {
		const value = JSON.stringify(jsonData);
		document.cookie = `${name}=${encodeURIComponent(value)}`;
	}

	function getJsonCookie(name) {
		const value = `; ${document.cookie}`;
		const parts = value.split(`; ${name}=`);
		if (parts.length === 2) {
			return JSON.parse(
				decodeURIComponent(parts.pop().split(";").shift())
			);
		}
		return null; // Returns null if the cookie doesn't exist
	}

	function deleteJsonCookie(name) {
		document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC;`;
	}

	document.addEventListener("user-data", (e: UserDataEvent) => {
		const userData = e.detail.data;
		const functionName = e.detail.function;

		switch (functionName) {
			case "set":
				setJsonCookie("user-data", userData);
				break;
			case "delete":
				deleteJsonCookie("user-data");
				break;
		}
	});

	// Check hash on initial load
	if (window.location.hash) {
		const hash = window.location.hash.slice(1);
		if (hash in pageContainers) {
			showPage(hash);
		}
	} else {
		window.location.hash = "countdown"; //
		showPage("countdown");
	}
</script>
